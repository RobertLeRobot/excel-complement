import{ActivationPlanningConsultant,modifPlanningConsultant,ChgtFeuilleConsultant}from"./1_ModifConsultants.js";import{ActivationPlanningMission,modifPlanningMission,ChgtFeuilleMission}from"./2_ModifMissions.js";import{ActivationPlanningGlobal,ChgtFeuilleGlobal}from"./3_PlanningGlobal.js";import{ActivationPlanningEncadrant,ChgtFeuilleEncadrant}from"./3_PlanningEncadrant.js";import{formatProtection,formatMissions,formatConsultants,formatSemaine,applyNewRangeToConditionnalFormat}from"./0_Format.js";import{handleClick,nouvelleMission,suppressionMission,affectationMission,affectationConsultant}from"./0_Gestion_des_boutons.js";import{PLANNING_TITLE,sharepointUrl}from"../commands/commands.js";export const globalVar={debug:!0,isProcessing:!1,nbExecModifConsultant:1,nbExecModifMission:1,nbExecModifEncadrant:1,nbExecModifGlobal:1};async function initializeWorkbookSettings(){await Excel.run(async e=>{if(globalVar.debug&&console.log("Initialisation du classeur : Désactivation du calcul automatique"),e.application.calculationMode=Excel.CalculationMode.manual,globalVar.debug){const n=e.application;await n.load("calculationState"),await e.sync(),console.log("calculationState initial",n.calculationState)}const n=e.workbook;globalVar.debug&&console.log(n),n.worksheets.onActivated.add(handleSheetChange);const o=n.properties;o.load("title");const t=n.worksheets.getActiveWorksheet();await t.load("name"),await e.sync(),handleButtonDisplay(t.name,o.title),await e.sync(),globalVar.debug&&console.log("Calcul automatique désactivé")}).catch(e=>{console.error("Erreur lors de l'initialisation du classeur : "+e),e instanceof OfficeExtension.Error&&console.error("Error globalVar.debug info: "+JSON.stringify(e.debugInfo))})}globalVar.debug&&console.log(globalVar.isProcessing),Office.onReady(e=>{e.host===Office.HostType.Excel&&(globalVar.debug&&console.log("Office est prêt, chargement de la fonction qui se déclenche s'il y a un changement sur le fichier"),initializeWorkbookSettings(),addWorksheetChangeHandler(),initializeButton())});export async function handleSheetChange(e){await Excel.run(async e=>{const n=e.workbook.worksheets.getActiveWorksheet(),o=e.workbook.properties;o.load("title"),await n.load("name"),await e.sync(),handleButtonDisplay(n.name,o.title)})}function addWorksheetChangeHandler(){Excel.run(async e=>{globalVar.debug&&console.log("Ajout du gestionnaire de boutons.");const n=e.workbook.worksheets.getActiveWorksheet();await n.load("name"),await e.sync(),globalVar.debug&&console.log("Ajout des gestionnaires de changement pour les feuilles '1. Liste des missions', '2. Planning - Consultant', '2. Planning - Missions', '3. Planning - Encadrant, '3. Planning - Global' et '3. Recap'");const o=e.workbook.worksheets.getItem("2. Planning - Consultant");o.onActivated.add(ActivationPlanningConsultant),o.onChanged.add(ChgtFeuilleConsultant),globalVar.debug&&console.log("Chargement des fonctions de la feuille",o);const t=e.workbook.worksheets.getItem("2. Planning - Missions");t.onActivated.add(ActivationPlanningMission),t.onChanged.add(ChgtFeuilleMission),globalVar.debug&&console.log("Chargement des fonctions de la feuille",t);const a=e.workbook.worksheets.getItem("3. Planning - Encadrant");a.onActivated.add(ActivationPlanningEncadrant),a.onChanged.add(ChgtFeuilleEncadrant),globalVar.debug&&console.log("Chargement des fonctions de la feuille",a);const l=e.workbook.worksheets.getItem("3. Planning - Global");l.onActivated.add(ActivationPlanningGlobal),l.onChanged.add(ChgtFeuilleGlobal),globalVar.debug&&console.log("Chargement des fonctions de la feuille",l);const i=e.workbook.worksheets.getItem("3. Recap");i.onActivated.add(ActivationRecap),globalVar.debug&&console.log("Chargement des fonctions de la feuille",i);const s=e.workbook.worksheets.getItem("1. Liste des missions");s.onActivated.add(ActivationListeMissions),globalVar.debug&&console.log("Chargement des fonctions de la feuille",s),globalVar.debug&&console.log("Gestionnaire de changement ajouté.")}).catch(function(e){console.error("Erreur : "+e),e instanceof OfficeExtension.Error&&console.error("Error globalVar.debug info: "+JSON.stringify(e.debugInfo))})}export function handleButtonDisplay(e,n){try{document.querySelectorAll("section").forEach(e=>{e.style.display="none"}),console.log("avant boucle :",e,n),"1. Liste des missions"===e?(console.log("boucle 1 :",e,n),document.getElementById("sec-btn-AjoutMission").style.display="flex",document.getElementById("sec-btn-Suppression").style.display="flex"):"2. Planning - Missions"===e?(console.log("boucle 2 :",e,n),document.getElementById("sec-btn-AjoutMission").style.display="flex",document.getElementById("sec-btn-Suppression").style.display="flex",document.getElementById("sec-btn-ModifierAffectationMission").style.display="flex"):"2. Planning - Consultant"===e?(console.log("boucle 3 :",e,n),document.getElementById("sec-btn-AjoutMission").style.display="flex",document.getElementById("sec-btn-Suppression").style.display="flex",document.getElementById("sec-btn-ModifierAffectationConsultant").style.display="flex"):n!==PLANNING_TITLE&&(console.log("boucle 4 :",e,n),document.getElementById("sec-btn-OpenPlanning").style.display="flex")}catch(e){console.error("Erreur lors de la mise à jour du volet :",e)}}export function initializeButton(){document.getElementById("btn-AjoutMission").addEventListener("click",handleClick),document.getElementById("btn-Suppression").addEventListener("click",handleClick),document.getElementById("btn-ModifierAffectationMission").addEventListener("click",handleClick),document.getElementById("btn-ModifierAffectationConsultant").addEventListener("click",handleClick),document.getElementById("btn-open-planning").addEventListener("click",handleClick),document.querySelectorAll('[id*="btn-return"]').forEach(e=>{e.addEventListener("click",handleClick)})}export async function ajoutModif(e,n,o){await Excel.run(async t=>{globalVar.debug=!0;const a=t.workbook.worksheets.getItem("Suivi Modif");await a.load("name");let l=a.getRange("A:A").getUsedRange();await l.load("rowCount"),await t.sync();let i=l.rowCount+1;globalVar.debug&&console.log("Nombre de lignes utilisées dans wsSuivi :",i),a.getCell(i-1,0).values=[[e]],a.getCell(i-1,1).values=[[n]],a.getCell(i-1,2).values=[[o]];let s="Utilisateur inconnu";globalVar.debug&&console.log("Office.context :",Office.context),Office.context&&Office.context.user&&Office.context.user.displayName?s=Office.context.user.displayName:console.warn("Impossible de récupérer le nom de l'utilisateur."),await t.sync(),a.getCell(i-1,3).values=[[s]];const c=new Date,r=`${String(c.getDate()).padStart(2,"0")}/${String(c.getMonth()+1).padStart(2,"0")}/${c.getFullYear()} ${String(c.getHours()).padStart(2,"0")}:${String(c.getMinutes()).padStart(2,"0")}:${String(c.getSeconds()).padStart(2,"0")}`;a.getCell(i-1,4).values=[[r]],globalVar.debug&&console.log("Informations de suivi ajoutées pour la ligne :",i),globalVar.debug=!0}).catch(e=>{globalVar.debug=!0,console.error("Erreur lors l'ajout du suivi des modifications : "+e),e instanceof OfficeExtension.Error&&console.error("Error globalVar.debug info: "+JSON.stringify(e.debugInfo))})}async function ActivationRecap(){await Excel.run(async e=>{globalVar.debug=!1,globalVar.debug&&console.log("Activation de la feuille 3. Recap");const n=e.application;n.screenUpdating=!1,n.calculate(),await formatSemaine("3. Recap",3),n.screenUpdating=!0,await e.sync(),globalVar.debug=!0}).catch(e=>{globalVar.debug=!0,console.error("Erreur lors de l'exécution de ActivationRecap :",e),e instanceof OfficeExtension.Error&&console.error("Error globalVar.debug info: "+JSON.stringify(e.debugInfo))})}async function ActivationListeMissions(){await Excel.run(async e=>{globalVar.debug=!1,globalVar.debug&&console.log("Activation de la feuille 1. Liste des missions");const n=e.application;n.screenUpdating=!1,n.calculate(),await formatSemaine("1. Liste des missions",3),n.screenUpdating=!0,await e.sync(),globalVar.debug=!0}).catch(e=>{globalVar.debug=!0,console.error("Erreur lors de l'exécution de ActivationListeMissions :",e),e instanceof OfficeExtension.Error&&console.error("Error globalVar.debug info: "+JSON.stringify(e.debugInfo))})}